<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Company Manager Dashboard</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    .form-group input, .form-group select { display: block; margin: 5px 0; padding: 5px; width: 100%; max-width: 400px; }
    .company-list div, .carousel-card { margin: 10px 0; padding: 10px; border: 1px solid #ccc; }
    button { margin: 5px; padding: 5px 10px; }
  </style>
</head>
<body>
  <section class="filter-export">
    <label for="ownerFilter">Filter by Owner:</label>
    <select id="ownerFilter"><option value="">All Owners</option></select>
    <button id="exportBtn">Export Companies</button>
    <button id="clearBtn">Clear All</button>
    <button id="syncToGitHubBtn">Sync to GitHub</button>
    <button id="loadFromGitHubBtn">Load from GitHub</button>
  </section>

  <section class="carousel-viewer">
    <h3>Company Carousel Viewer</h3>
    <div id="carouselDisplay" class="carousel-card" aria-live="polite"></div>
    <div>
      <button id="prevBtn">Previous</button>
      <button id="nextBtn">Next</button>
    </div>
  </section>

  <section class="company-manager">
    <h3>Manage Companies</h3>
    <form id="companyForm">
      <div class="form-group">
        <input type="text" id="companyName" placeholder="Company name" required />
        <input type="text" id="streetAddress" placeholder="Street Address" />
        <input type="text" id="city" placeholder="City" />
        <input type="text" id="state" placeholder="State" />
        <input type="text" id="zipCode" placeholder="ZIP Code" />
        <input type="text" id="companyEIN" placeholder="SSN or EIN" />
        <input type="text" id="companySEIN" placeholder="State EIN #" />

        <!-- OWNER SECTION (Visible for all types except partnership logic handled in JS) -->
        <div id="ownersSection">
          <h4>Owner</h4>
          <div id="ownersContainer"></div>
          <input type="text" id="Owner" placeholder="Owner name" />
          <button type="button" id="addOwnerBtn">Add Owner</button>
        <!-- PARTNER SECTION (Visible for type partnership logic handled in JS) -->
          <h5>Partners *use only for company type partnership*</h5>
          <input type="text" id="Partner" placeholder="Partner name" /><input type="text" id="PartnerShare" placeholder="Partner share %" />
          <button type="button" id="addPartberBtn">Add Partner</button>
        </div>
        
          <select id="companyRole">
          <option value="RoleType">-Role Type-</option>
          <option value="Viewer">Viewer</option>
          <option value="Editor">Editor</option>
          <option value="Owner">Owner</option>
        </select>

        <select id="companyType">
          <option value="">-Company type-</option>
          <option value="Sole Proprietor">Sole Proprietor</option>
          <option value="Partnership">Partnership</option>
          <option value="LLC">LLC</option>
          <option value="Corporation">Corporation</option>
          <option value="Nonprofit">Nonprofit</option>
        </select>

        <!-- PARTNER SECTION (ONLY FOR PARTNERSHIP) -->
        <div id="partnerSection" style="display:none;">
          <h4>Partners</h4>
          <div id="partnersContainer"></div>
          <button type="button" id="addPartnerBtn">Add Partner</button>
          <p id="ownershipWarning" style="color:red; display:none;">Total partner ownership must equal 100%.</p>
        </div>

        <button type="submit">Add</button>
      </div>
    </form>

    <div class="company-list" id="companyList"></div>
  </section>

  <script>

    /* ==============================
       GLOBAL VARIABLES
    ============================== */
    let companies = JSON.parse(localStorage.getItem('companies')) || [];
    let carouselIndex = 0;

    const companyForm = document.getElementById('companyForm');
    const companyList = document.getElementById('companyList');
    const carouselDisplay = document.getElementById('carouselDisplay');
    const ownerFilter = document.getElementById('ownerFilter');
    const companyTypeSelect = document.getElementById('companyType');

    const ownersContainer = document.getElementById('ownersContainer');
    const ownersSection = document.getElementById('ownersSection');
    const partnersContainer = document.getElementById('partnersContainer');
    const partnerSection = document.getElementById('partnerSection');
    const ownershipWarning = document.getElementById('ownershipWarning');

    /* ==============================
       INITIAL OWNER INPUT
    ============================== */
    function addInitialOwner() {
      if (ownersContainer.children.length === 0) {
        addOwner();
      }
    }
    addInitialOwner();

    function addOwner(name = "", email = "", role = "") {
      const index = ownersContainer.children.length;
      const div = document.createElement('div');
      div.className = 'owner-entry';
      div.innerHTML = `
        <input type="text" placeholder="Owner Name" name="ownerName${index}" value="${name}" required />
        <input type="email" placeholder="Email" name="ownerEmail${index}" value="${email}" />
        <input type="text" placeholder="Role" name="ownerRole${index}" value="${role}" />
        <button type="button" onclick="this.parentElement.remove()">Remove</button>
      `;
      ownersContainer.appendChild(div);
    }

    document.getElementById('addOwnerBtn').addEventListener('click', () => addOwner());


    /* ==============================
       PARTNER INPUT
    ============================== */
    function addPartner(name = "", email = "", role = "", share = "") {
      const index = partnersContainer.children.length;
      const div = document.createElement('div');
      div.className = 'partner-entry';
      div.innerHTML = `
        <input type="text" placeholder="Partner Name" name="partnerName${index}" value="${name}" required />
        <input type="email" placeholder="Email" name="partnerEmail${index}" value="${email}" />
        <input type="text" placeholder="Role" name="partnerRole${index}" value="${role}" />
        <input type="number" placeholder="Ownership %" name="partnerShare${index}" value="${share}" min="0" max="100" required />
        <button type="button" onclick="this.parentElement.remove()">Remove</button>
      `;
      partnersContainer.appendChild(div);
    }

    document.getElementById('addPartnerBtn').addEventListener('click', () => addPartner());


    /* ==============================
       COMPANY TYPE CHANGE LOGIC
    ============================== */
    companyTypeSelect.addEventListener('change', () => {
      const isPartnership = companyTypeSelect.value === "Partnership";

      if (isPartnership) {
        ownersSection.style.display = 'block';
        partnerSection.style.display = 'block';
      } else {
        ownersSection.style.display = 'block';
        partnerSection.style.display = 'none';
        partnersContainer.innerHTML = "";
        ownershipWarning.style.display = "none";
      }
    });



    /* ==============================
       FORM SUBMIT HANDLER
    ============================== */
    companyForm.addEventListener('submit', function(e) {
      e.preventDefault();

      const companyType = companyTypeSelect.value;
      const companyName = document.getElementById('companyName').value;

      /* Collect Owners */
      let owners = [...ownersContainer.querySelectorAll('.owner-entry')].map(entry => ({
        name: entry.querySelector('input[name^="ownerName"]').value,
        email: entry.querySelector('input[name^="ownerEmail"]').value,
        role: entry.querySelector('input[name^="ownerRole"]').value
      }));

      /* Collect Partners (only for partnership) */
      let partners = [];
      if (companyType === "Partnership") {
        partners = [...partnersContainer.querySelectorAll('.partner-entry')].map(entry => ({
          name: entry.querySelector('input[name^="partnerName"]').value,
          email: entry.querySelector('input[name^="partnerEmail"]').value,
          role: entry.querySelector('input[name^="partnerRole"]').value,
          share: parseFloat(entry.querySelector('input[name^="partnerShare"]').value)
        }));

        // Validate 100% share
        const totalShare = partners.reduce((sum, p) => sum + p.share, 0);
        if (totalShare !== 100) {
          ownershipWarning.style.display = 'block';
          return;
        } else {
          ownershipWarning.style.display = 'none';
        }
      }

      /* Build Company Object */
      const company = {
        name: companyName,
        address: document.getElementById('streetAddress').value,
        city: document.getElementById('city').value,
        state: document.getElementById('state').value,
        zip: document.getElementById('zipCode').value,
        ein: document.getElementById('companyEIN').value,
        sein: document.getElementById('companySEIN').value,
        role: document.getElementById('companyRole').value,
        type: companyType,
        owners,
        partners
      };

      companies.push(company);
      localStorage.setItem('companies', JSON.stringify(companies));
      updateCompanyList();
      updateOwnerFilter();
      updateCarousel();

      companyForm.reset();
      ownersContainer.innerHTML = "";
      partnersContainer.innerHTML = "";
      addInitialOwner();

      partnerSection.style.display = 'none';
    });



    /* ==============================
       LIST, FILTER, CAROUSEL DISPLAY
    ============================== */
    function updateCompanyList() {
      const filter = ownerFilter.value;
      const list = companies.filter(c => !filter || c.owners.some(o => o.name === filter));
      companyList.innerHTML = list.map((c, i) =>
        `<div>${c.name} (${c.owners.map(o => o.name).join(", ")}) - ${c.type}
          <button onclick="editCompany(${i})">Edit</button>
        </div>`
      ).join('');
    }

    function updateOwnerFilter() {
      const allOwners = companies.flatMap(c => c.owners.map(o => o.name));
      const uniqueOwners = [...new Set(allOwners)];
      ownerFilter.innerHTML = `<option value="">All Owners</option>` +
        uniqueOwners.map(o => `<option value="${o}">${o}</option>`).join('');
    }

    function updateCarousel() {
      if (companies.length === 0) {
        carouselDisplay.innerHTML = "<em>No companies added yet.</em>";
        return;
      }
      const c = companies[carouselIndex % companies.length];
      carouselDisplay.innerHTML = `
        <strong>${c.name}</strong><br>
        ${c.city}, ${c.state}<br>
        Type: ${c.type}<br>
        <strong>Owners:</strong>
        <ul>${c.owners.map(o => `<li>${o.name}</li>`).join("")}</ul>
        ${c.partners?.length ? `<strong>Partners:</strong><ul>${c.partners.map(p => `<li>${p.name} (${p.share}%)</li>`).join("")}</ul>` : ""}
      `;
    }


    /* ==============================
       CAROUSEL BUTTONS
    ============================== */
    document.getElementById('prevBtn').addEventListener('click', () => {
      carouselIndex = (carouselIndex - 1 + companies.length) % companies.length;
      updateCarousel();
    });

    document.getElementById('nextBtn').addEventListener('click', () => {
      carouselIndex = (carouselIndex + 1) % companies.length;
      updateCarousel();
    });


    /* ==============================
       EXPORT / CLEAR
    ============================== */
    document.getElementById('exportBtn').addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(companies, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'companies.json';
      a.click();
      URL.revokeObjectURL(url);
    });

    document.getElementById('clearBtn').addEventListener('click', () => {
      if (confirm("Clear all companies?")) {
        companies = [];
        localStorage.removeItem('companies');
        updateCompanyList();
        updateOwnerFilter();
        updateCarousel();
      }
    });

    ownerFilter.addEventListener('change', updateCompanyList);


    /* ==============================
       GITHUB SYNC (UNSECURED DEMO)
    ============================== */
    const GITHUB_USERNAME = "your-username";
    const REPO_NAME = "company-dashboard-data";
    const FILE_PATH = "companies.json";
    const BRANCH = "main";
    const TOKEN = "ghp_your_personal_access_token";

    async function syncToGitHub() {
      const apiUrl = `https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/${FILE_PATH}`;
      try {
        const getRes = await fetch(apiUrl, {
          headers: { Authorization: `token ${TOKEN}` }
        });
        const fileData = await getRes.json();
        const sha = fileData.sha;

        const content = btoa(unescape(encodeURIComponent(JSON.stringify(companies, null, 2))));
        const res = await fetch(apiUrl, {
          method: "PUT",
          headers: {
            Authorization: `token ${TOKEN}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            message: "Sync companies.json from dashboard",
            content,
            sha,
            branch: BRANCH
          })
        });

        alert(res.ok ? "Synced to GitHub!" : "GitHub sync failed.");
      } catch (err) {
        alert("Error: " + err.message);
      }
    }

    async function loadFromGitHub() {
      const apiUrl = `https://raw.githubusercontent.com/${GITHUB_USERNAME}/${REPO_NAME}/${BRANCH}/${FILE_PATH}`;
      try {
        const res = await fetch(apiUrl);
        if (res.ok) {
          companies = await res.json();
          localStorage.setItem("companies", JSON.stringify(companies));
          updateCompanyList();
          updateOwnerFilter();
          updateCarousel();
          alert("Loaded from GitHub!");
        }
      } catch (err) {
        alert("Error: " + err.message);
      }
    }

    document.getElementById("syncToGitHubBtn").addEventListener("click", syncToGitHub);
    document.getElementById("loadFromGitHubBtn").addEventListener("click", loadFromGitHub);

    /* INITIAL LOAD */
    updateCompanyList();
    updateOwnerFilter();
    updateCarousel();

  </script>
</body>
</html>